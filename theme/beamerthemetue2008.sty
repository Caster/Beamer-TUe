\RequirePackage{beamerbasethemes}
\RequirePackage{ifthen}
\RequirePackage{lastpage}
\RequirePackage{pgfpages}
\RequirePackage{tikz} % for quotes, see below
\RequirePackage{xparse}

\DeclareOptionBeamer{theme}
{\PassOptionsToPackage{theme=#1}{beamercolorthemetue2008plain}}

\DeclareOptionBeamer{department}
{\PassOptionsToPackage{department=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{statustext}
{\PassOptionsToPackage{statustext=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{titlelogo}
{\PassOptionsToPackage{titlelogo=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{titlebgimage}
{\PassOptionsToPackage{titlebgimage=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{titlebgimagetransparency}
{\PassOptionsToPackage{titlebgimagetransparency=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{compress}{\beamer@compresstrue}

\DeclareOptionBeamer{official}
{\PassOptionsToPackage{official=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{innovation}
{\PassOptionsToPackage{innovation=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{realpagenumbers}
{\PassOptionsToPackage{realpagenumbers=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{tocslides}
{\PassOptionsToPackage{tocslides=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{tocplain}
{\PassOptionsToPackage{tocplain=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{tocstyle}
{\PassOptionsToPackage{tocstyle=#1}{beamerouterthemetue2008plain}}

\DeclareOptionBeamer{tuefont}
{\ifthenelse{\equal{#1}{false}}{\PassOptionsToPackage{tuefont}{tuestyle2008}}{}}
%As there are only two options we only need to pass tuefont as option when we want the non-default behavior

\newcommand{\spp}{1}
\DeclareOptionBeamer{slidesperpage}{\renewcommand{\spp}{#1}}

\only<handout>{
  \renewcommand{\spp}{2}
}


\ProcessOptionsBeamer

\pgfpagesdeclarelayout{3 on 1}
{
  \edef\pgfpageoptionheight{\the\paperwidth} % landscaped by default
  \edef\pgfpageoptionwidth{\the\paperheight}
  \def\pgfpageoptionborder{0pt}
  \def\pgfpageoptionfirstshipout{1}
}
{
  \pgfpagesphysicalpageoptions
  {%
    logical pages=3,%
    physical height=\pgfpageoptionheight,%
    physical width=\pgfpageoptionwidth,%
    current logical shipout=\pgfpageoptionfirstshipout%
  }
  \ifdim\paperheight>\paperwidth\relax
    % put side-by-side
    \pgfpageslogicalpageoptions{1}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.33\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.1667\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{2}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.33\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{3}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.33\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.8333\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
  \else
    % stack on top of one another
    \pgfpageslogicalpageoptions{1}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=\pgfphysicalwidth,%
      resized height=.33\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.8333\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{2}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=\pgfphysicalwidth,%
      resized height=.33\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{3}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=\pgfphysicalwidth,%
      resized height=.33\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.1667\pgfphysicalheight}%
    }%
  \fi
}

\pgfpagesdeclarelayout{6 on 1}
{
  \edef\pgfpageoptionheight{\the\paperwidth} % landscaped by default
  \edef\pgfpageoptionwidth{\the\paperheight}
  \def\pgfpageoptionborder{0pt}
  \def\pgfpageoptionfirstshipout{1}
}
{
  \pgfpagesphysicalpageoptions
  {%
    logical pages=6,%
    physical height=\pgfpageoptionheight,%
    physical width=\pgfpageoptionwidth,%
    current logical shipout=\pgfpageoptionfirstshipout%
  }
  \ifdim\paperheight>\paperwidth\relax
    % put side-by-side
    \pgfpageslogicalpageoptions{1}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.1667\pgfphysicalwidth}{.25\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{3}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.25\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{5}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.8333\pgfphysicalwidth}{.25\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{2}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.1667\pgfphysicalwidth}{.75\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{4}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.5\pgfphysicalwidth}{.75\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{6}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.8333\pgfphysicalwidth}{.75\pgfphysicalheight}%
    }%
  \else
    % stack on top of one another
    \pgfpageslogicalpageoptions{1}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.25\pgfphysicalwidth}{.8333\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{3}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.25\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{5}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.25\pgfphysicalwidth}{.1667\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{2}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.75\pgfphysicalwidth}{.8333\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{4}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.75\pgfphysicalwidth}{.5\pgfphysicalheight}%
    }%
    \pgfpageslogicalpageoptions{6}
    {%
      border shrink=\pgfpageoptionborder,%
      resized width=0.5\pgfphysicalwidth,%
      resized height=\pgfphysicalheight,%
      center=\pgfpoint{.75\pgfphysicalwidth}{.1667\pgfphysicalheight}%
    }%
  \fi
}

\ifthenelse{\equal{\spp}{2}}{\pgfpagesuselayout{2 on 1}[a4paper,border shrink=5mm]}{}
\ifthenelse{\equal{\spp}{3}}{\pgfpagesuselayout{3 on 1}[a4paper,border shrink=5mm]}{}
\ifthenelse{\equal{\spp}{4}}{\pgfpagesuselayout{4 on 1}[a4paper,border shrink=5mm,landscape]}{}
\ifthenelse{\equal{\spp}{6}}{\pgfpagesuselayout{6 on 1}[a4paper,border shrink=5mm]}{}

\newenvironment{slide}{\begin{frame}[fragile,environment=slide]\vfill}{\vfill\end{frame}}
\newenvironment{slidetop}{\begin{frame}[fragile,environment=slidetop]}{\end{frame}}
\newenvironment{titleframe}{\usebackgroundtemplate{\drawtitlebackground}\begin{frame}[fragile,environment=titleframe]}
  {\end{frame}\usebackgroundtemplate{\drawbackground}}
\RenewDocumentEnvironment{plainframe}{G{}}%
  {%
    \usebackgroundtemplate{\drawbackground[plain]}%
    \setlength{\frametitleheight}{1.5cm}%
    \if\relax\detokenize{#1}\relax\relax\else%
      \setbeamertemplate{frametitle}{%
        \vspace*{-\frametitleheight}%
        \begin{center}\LARGE \alert{\insertframetitle}\end{center}%
      }%
    \fi%
    \begin{frame}[fragile,environment=plainframe]%
    \frametitle{{#1}}%
    \if\relax\detokenize{#1}\relax\relax\else%
      \vspace*{-0.525\frametitleheight}%
    \fi%
  }%
  {%
    \end{frame}%
    \usebackgroundtemplate{\drawbackground}%
  }

% improve quote environment
\let\oldquoteenv\quote
\let\endoldquoteenv\endquote
% http://tex.stackexchange.com/a/16981/23145
\newcommand*\quotesize{60}
\newcommand*{\openquote}
   {\tikz[remember picture,overlay,xshift=-4ex,yshift=-1em+1ex]
   \node (OQ) {\fontsize{\quotesize}{\quotesize}\selectfont\textcolor{themecolor}{``}};\kern0pt}
\newcommand*{\closequote}[1]
  {\tikz[remember picture,overlay,xshift=2ex,yshift={#1}]
   \node (CQ) {\fontsize{\quotesize}{\quotesize}\selectfont\textcolor{themecolor}{''}};}
% http://tex.stackexchange.com/a/162789/23145
\RenewDocumentEnvironment{quote}{O{0.9\textwidth}O{.4em}G{}O{}}%
  {%
    \vspace{#2}\begin{minipage}{#1}\oldquoteenv\openquote
  }%
  {%
    \hfill\closequote{-0.7ex}%
    \item[]\mbox{}\hfill\alert{\footnotesize\textsc{#3}}
    \if\relax\detokenize{#4}\relax\relax\else%
      \footnotesize -- #4
    \fi%
    \endoldquote\end{minipage}
  }
\NewDocumentEnvironment{oldquote}{}{\oldquoteenv}{\endoldquoteenv}

\mode<presentation>

\useinnertheme{default}
\useoutertheme{tue2008plain}
\usecolortheme{tue2008plain}
\usefonttheme{tue2008plain}

\hypersetup{
  colorlinks=true,
  linkcolor=themecolor,
  urlcolor=themecolor,
}

\mode<all>
